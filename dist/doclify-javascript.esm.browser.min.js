/*!
  * @doclify/javascript v3.0.1
  * (c) 2020 Doclify
  * @license MIT
  */
/*!
  * @doclify/javascript v3.0.1
  * (c) 2020 Doclify
  * @license MIT
  */
import e from"axios";class t{constructor(e){this.client=e,this.langCode=e.config.lang,this.q=[],this.includeQuery=[],this.selectQuery=[],this.orderQuery=[]}where(e,t,r){return void 0===r&&(r=t,t="eq"),this.q.push([e,t,r]),this}collection(e){return this.eq("sys.collection",e)}contentType(e){return this.eq("sys.contentType",e)}id(e){return this.eq("sys.id",e)}uid(e){return this.eq("sys.uid",e)}eq(e,t){return this.where(e,t)}not(e,t){return this.where(e,"not",t)}in(e,t){return this.where(e,"in",t)}nin(e,t){return this.where(e,"nin",t)}gt(e,t){return this.where(e,"gt",t)}gte(e,t){return this.where(e,"gte",t)}lt(e,t){return this.where(e,"lt",t)}lte(e,t){return this.where(e,"lte",t)}fulltext(e,t){return this.where(e,"fulltext",t)}match(e,t){return this.where(e,"match",t)}query(e){if("function"!=typeof e)throw new TypeError("Query parameter must be function.");return e.call(this,this),this}lang(e){return this.langCode=e,this}with(e){return this.include(e)}include(...e){return e.length&&Array.isArray(e[0])&&(e=e[0]),this.includeQuery.push(...e),this}select(...e){return e.length&&Array.isArray(e[0])&&(e=e[0]),this.selectQuery.push(...e),this}orderBy(e,t){return this.orderQuery.push([e,t||"asc"]),this}getParams(e={}){return Object.assign({q:JSON.stringify(this.q),include:this.includeQuery.length?JSON.stringify(this.includeQuery):void 0,order:this.orderQuery.length?JSON.stringify(this.orderQuery):void 0,select:this.selectQuery.length?JSON.stringify(this.selectQuery):void 0,lang:this.langCode},e)}fetch(e){return this.client.cachedRequest("documents/search",{params:this.getParams({limit:e})})}paginated(e,t){return this.paginate(e,t)}paginate(e,t){return this.client.cachedRequest("documents/paginated",{params:this.getParams({perPage:t,page:e})})}first(){return this.client.cachedRequest("documents/single",{params:this.getParams()})}}class r extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,new.target.prototype),this.info=t}get url(){return this.info.url}get method(){return this.info.method.toUpperCase()}get code(){return`${this.info.code||-1}`}get params(){return this.info.params||{}}get error(){return this.info.error||null}get data(){return this.info.data||{}}toString(){return["Doclify call failed:",`${this.method} ${this.url} ${JSON.stringify(this.params)} -`,this.message,`(code ${this.code})`].join(" ")}static fromError(e){const t={code:e.response?e.response.status:null,url:e.request.url,method:e.request.method,data:e.response?e.response.data:null};return new r(e.message,t)}}function s(e){return JSON.parse(JSON.stringify(e))}export default class{constructor(t={}){if(!t.url){if(!t.repository)throw new TypeError("Repository or URL option is required.");if(!t.key&&!t.token)throw new TypeError("API key/token is required.")}t.token=t.token||t.key||null,t.cache&&(this.setCache(t.cache),delete t.cache),this.config=Object.assign({url:null,repository:null,token:null,lang:null,timeout:1e4},t);const r={};this.config.token&&(r.Authorization="Bearer "+this.config.token),this.http=e.create({baseURL:this.baseUrl,timeout:this.config.timeout,headers:r}),this.http.interceptors.response.use(e=>e,(function(e){return Promise.reject(e)}))}get baseUrl(){return this.config.url||`https://${this.config.repository}.cdn.doclify.io/api/v2`}setCache(e){this.cache=e}setLang(e){this.config.lang=e}getCacheKey(e,t){const r=[];return Object.keys(t).sort().forEach(e=>{r.push(`${e}=${t[e]}`)}),`${e}?${r.join("&")}`}request(e,t={},s=!1){return t.params=t.params||{},this.config.lang&&!t.params.lang&&(t.params.lang=this.config.lang),this.http.request(e,t).then(e=>s?e:e.data).catch(s=>{const i=s.response&&s.response.data?s.response.data:{},n={url:this.baseUrl+"/"+e,code:s.response?s.response.status:-1,params:t.params,method:t.method||"GET",error:i.error||null,data:i},h=i.error?i.error.message:s.message;return Promise.reject(new r(h,n))})}cachedRequest(e,t={}){if(!this.cache)return this.request(e,t);const r=this.getCacheKey(e,t.params||{}),i=this.cache.get(r);if(i instanceof Promise)return i.then(e=>s(e.data));if(i instanceof Error)return Promise.reject(i);if(void 0!==i)return Promise.resolve(s(i));const n=this.request(e,t,!0);return this.cache.set(r,n),n.then(e=>(this.cache.set(r,e.data),s(e.data))).catch(e=>{throw this.cache.set(r,e),e})}documents(){return new t(this)}}